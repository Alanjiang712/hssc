{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}{{ block.super }}<link rel="stylesheet" type="text/css" href="{% static "admin/css/dashboard.css" %}">{% endblock %}

{% block coltype %}colMS{% endblock %}

{% block bodyclass %}{{ block.super }} dashboard{% endblock %}

{% block breadcrumbs %}{% endblock %}

{% block nav-sidebar %}{% endblock %}

<script src="htmx.min.js" defer></script>
{% block content %}
    <h3>病例首页</h3>
    {{ profile.name }}
    {{ profile.phone }}
    {{ profile.address }}
    {{ profile.charge_staff }}
    {{ profile.workgroup.label }}
    <a href="{{ profile.get_absolute_url }}">查看详情</a>
    <br>
    <hr>
    <br>
    <h3>已安排服务</h3>
    {% for proc in scheduled_services %}
        <a href="{{ proc.entry }}">{{ proc.service.label }}  {{ proc.permisssion }}</a>
        <br>
    {% endfor %}
    <br>
    <hr>
    <br>
    <h3>历史服务</h3>
    {% for proc in history_services %}
        <a href="{{ proc.entry }}">{{ proc.service.label }}</a>
        <br>
    {% endfor %}
    <br>
    <hr>
    <br>
    <input type="submit" value="新增服务计划安排" onclick="location.href='/clinic/';"/>
    <span>
        <input type="button" value="新增服务" hx-trigger="click" hx-get="/core/get_services_list/{{ profile.id }}" hx-target="#popup_menu" hx-swap="innerHTML" />
        <select id="popup_menu" onchange="javascript:handleSelect(this)"></select>
    </span>
    <input type="submit" value="退出" onclick="location.href='/clinic/';"/>

    {% verbatim %}
    <div id="app">
        <h3>可选服务</h3>
        <div v-for="service in recommendedServices" :key="service.id">
            <a :href="'/core/new_service/' + service.customer_id + '/' + service.service_id + '/' + service.id + '/'">
                {{ service.service_name }}
                <span v-if="service.enable_queue_counter"> ({{ service.queue_count }})</span>
            </a>
        </div>
        <br>
        <hr>
        <br>    
    </div>

    {% endverbatim %}
    
    <script type="text/javascript">
        function handleSelect(item)
        {
            window.location = "/core/new_service/"+item.value+"/0/";
        }
    </script>

    <script src="https://unpkg.com/vue@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>    
    <script>
        const { createApp } = Vue;

        const customerServiceApp = {
            data() {
                return {
                    recommendedServices: null,
                    servicesList: null,
                }
            },
            created() {
                let _this = this;

                customerId = Cookies.get('customer_id')

                // 可选服务信道
                const recommendedServicesSocket = new WebSocket(`ws://${window.location.host}/ws/customer_recommended_services_list/${customerId}/`);
                recommendedServicesSocket.onmessage = function (event) {
                    _this.recommendedServices = JSON.parse(event.data);
                }

                // 已安排服务和历史服务信道
                const servicesListSocket = new WebSocket(`ws://${window.location.host}/ws/customer_services_list/${customerId}/`);
                servicesListSocket.onmessage = function (event) {
                    _this.servicesList = JSON.parse(event.data);
                }
            },
        };

        createApp(customerServiceApp).mount('#app');
    </script>

{% endblock %}